<!--
=========================================================
 Material Dashboard - v2.1.2
=========================================================

 Product Page: https://www.creative-tim.com/product/material-dashboard
 Copyright 2019 Creative Tim (https://www.creative-tim.com)
 Licensed under MIT (https://github.com/creativetimofficial/material-dashboard/blob/master/LICENSE.md)

 Coded by Creative Tim

=========================================================

 The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software. -->

<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8" />
  <link rel="apple-touch-icon" sizes="76x76" href="/static/assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="/static/assets/img/favicon.png">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <link rel="canonical" href="https://grc-poc-2">

  <title>
    GRC Made Simple - {% block title %}{% endblock %} | Gracen
  </title>

  {% include 'includes/scripts.html' %}
  {% include 'includes/scripts-sidebar.html' %}

  <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no'
    name='viewport' />
  <!--     Fonts and icons     -->
  <link rel="stylesheet" type="text/css"
    href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" />
    <link rel="stylesheet" type="text/css"
href="https://fonts.googleapis.com/css?family=Roboto|Material+Icons+Outlined" />
<!-- <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" /> -->
<!-- <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Material+Icons+Outlined:opsz,wght,FILL,GRAD@48,300,0,0" /> -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,300,0,0" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
  <!-- CSS Files -->
  <link href="/static/assets/css/material-dashboard.css?v=2.1.2" rel="stylesheet" />
  <link href="/static/assets/css/local.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">

  <!-- Specific Page CSS goes HERE  -->
  {% block stylesheets %}{% endblock stylesheets %}
  <script type="text/javascript" src="/static/assets/js/plugins/zxcvbn.js"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-JSBWGW4GEC"></script> 
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.0.0-rc.4/dist/css/tom-select.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.0.0-rc.4/dist/js/tom-select.complete.min.js"></script>
<script>
if(window.location.hostname == "app.gracen.io"){
  window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-JSBWGW4GEC');
}
function plotClickHandler(event) {
    var categoryLabel = event.data.categoryLabel;
    var search = "{{request.GET.search}}"
    if (search == "mine") {
        window.location.href = {% url 'vendors' %} + "?filter_by=status&param=" + categoryLabel + "&self=True";

    } else {
        window.location.href = {% url 'vendors' %} + "?filter_by=status&param=" + categoryLabel;
    }
}

function categoryPlotClickHandler(event) {
    var categoryLabel = event.data.categoryLabel;
    var search = "{{request.GET.search}}"
    if (search == "mine") {
        window.location.href = {% url 'vendors' %} + "?filter_by=category&param=" + categoryLabel + "&self=True";
    } else {
        window.location.href = {% url 'vendors' %} + "?filter_by=category&param=" + categoryLabel;
    }
}

function riskPlotClickHandler(event) {
    var risk = event.data.categoryLabel;
    if (risk == "None") {
        risk = 0
    } else if (risk == "Low") {
        risk = 1
    } else if (risk == "Medium") {
        risk = 2
    } else {
        risk = 3
    }
    var search = "{{request.GET.search}}"
    if (search == "mine") {
        window.location.href = {% url 'vendors' %} + "?filter_by=risk&param=" + risk + "&self=True";
    } else {
        window.location.href = {% url 'vendors' %} + "?filter_by=risk&param=" + risk;
    }
}

function incidentPlotClickHandler(event) {
    var status = event.data.categoryLabel;
    if (status == "Reported") {
        status = 1
    } else if (status == "Active") {
        status = 2
    } else if (status == "Extended Remediation") {
        status = 3
    } else if (status == "Closed") {
        status = 4
    } else {
        status = 5
    }
    window.location.href = {% url 'incidents' %} + "?status=" + status;
}

function taskPlotClickHandler(event) {
    var status = event.data.categoryLabel;
    if (status == "Not Started") {
        status = 1
    } else if (status == "In Process") {
        status = 2
    } else if (status == "On Hold") {
        status = 3
    } else if (status == "Cancelled") {
        status = 4
    } else {
        status = 5
    }
    var search = "{{request.GET.search}}"
    if (search == "mine") {
        window.location.href = {% url 'tasks' %} + "?filter_by=status&param=" + status + "&self=True";
    } else {
        window.location.href = {% url 'tasks' %} + "?filter_by=status&param=" + status;
    }

}

function risksPlotClickHandler(event) {
    var rating = event.data.categoryLabel;
    var search = "{{request.GET.search}}"
    if (search == "mine") {
        window.location.href = {% url 'risks' %} + "?rating=" + rating + "&self=True";
    } else {
        window.location.href = {% url 'risks' %} + "?rating=" + rating;
    }

}
</script>

<script type="text/javascript">
  const properties = [
  'direction',
  'boxSizing',
  'width',
  'height',
  'overflowX',
  'overflowY',

  'borderTopWidth',
  'borderRightWidth',
  'borderBottomWidth',
  'borderLeftWidth',
  'borderStyle',

  'paddingTop',
  'paddingRight',
  'paddingBottom',
  'paddingLeft',

  'fontStyle',
  'fontVariant',
  'fontWeight',
  'fontStretch',
  'fontSize',
  'fontSizeAdjust',
  'lineHeight',
  'fontFamily',

  'textAlign',
  'textTransform',
  'textIndent',
  'textDecoration',

  'letterSpacing',
  'wordSpacing',

  'tabSize',
  'MozTabSize',
]

const isFirefox = typeof window !== 'undefined' && window['mozInnerScreenX'] != null

/**
 * @param {HTMLTextAreaElement} element
 * @param {number} position
 */
function getCaretCoordinates(element, position) {
  const div = document.createElement('div')
  document.body.appendChild(div)
  const style = div.style
  const computed = getComputedStyle(element)

  style.whiteSpace = 'pre-wrap'
  style.wordWrap = 'break-word'
  style.position = 'absolute'
  style.visibility = 'hidden'

  properties.forEach(prop => {
    style[prop] = computed[prop]
  })

  if (isFirefox) {
    if (element.scrollHeight > parseInt(computed.height))
      style.overflowY = 'scroll'
  } else {
    style.overflow = 'hidden'
  }
  div.innerText = element.innerText.substring(0, position)

  const span = document.createElement('span')
  span.innerText = element.innerText.substring(position) || '.'
  div.appendChild(span)
  const coordinates = {
    top: span.offsetTop + parseInt(computed['borderTopWidth']),
    left: span.offsetLeft + parseInt(computed['borderLeftWidth']),
    height: span.offsetHeight
  }

  div.remove()
  return coordinates
}
function getCaretCharacterOffsetWithin(element) {
    var caretOffset = 0;
    var doc = element.ownerDocument || element.document;
    var win = doc.defaultView || doc.parentWindow;
    var sel;
    if (typeof win.getSelection != "undefined") {
        sel = win.getSelection();
        if (sel.rangeCount > 0) {
            var range = win.getSelection().getRangeAt(0);
            var preCaretRange = range.cloneRange();
            preCaretRange.selectNodeContents(element);
            preCaretRange.setEnd(range.endContainer, range.endOffset);
            caretOffset = preCaretRange.toString().length;
        }
    } else if ( (sel = doc.selection) && sel.type != "Control") {
        var textRange = sel.createRange();
        var preCaretTextRange = doc.body.createTextRange();
        preCaretTextRange.moveToElementText(element);
        preCaretTextRange.setEndPoint("EndToEnd", textRange);
        caretOffset = preCaretTextRange.text.length;
    }
    return caretOffset;
}


class Mentionify {
  constructor(ref, menuRef, resolveFn, replaceFn, menuItemFn, menu_id, textarea_id, div_id, top_diff, ev_type=null) {
    this.ref = ref
    this.menuRef = menuRef
    this.resolveFn = resolveFn
    this.replaceFn = replaceFn
    this.menuItemFn = menuItemFn
    this.options = []
    this.menu_id = menu_id
    this.div_id = div_id
    this.textarea_id = textarea_id
    this.top_diff = top_diff
    this.ev_type = ev_type
    
    this.makeOptions = this.makeOptions.bind(this)
    this.closeMenu = this.closeMenu.bind(this)
    this.selectItem = this.selectItem.bind(this)
    this.onInput = this.onInput.bind(this)
    this.onKeyDown = this.onKeyDown.bind(this)
    this.renderMenu = this.renderMenu.bind(this)
    
    this.ref.addEventListener('input', this.onInput)
    this.ref.addEventListener('keydown', this.onKeyDown)
  }
  
  async makeOptions(query) {
    const options = await this.resolveFn(query)
    if (options.lenght !== 0) {
      this.options = options
      this.renderMenu()
    } else {
      this.closeMenu()
    }
  }
  
  closeMenu() {
    setTimeout(() => {
      this.options = []
      this.left = undefined
      this.top = undefined
      this.triggerIdx = undefined
      this.renderMenu()
    }, 0)
  }
  
  selectItem(active) {
    return () => {
      $(this.menu_id).hide()
      let preMention =((this.ref.innerHTML).split("@"))
      preMention.pop()
      preMention = preMention.join("@")
      const option = this.options[active]
      const mention = this.replaceFn(option, this.ref.innerText[this.triggerIdx])
      const newValue = `${preMention} <a href="" id="${option.user_id}">${mention}</a>  `
      this.ref.innerHTML = newValue
      this.closeMenu()
      this.ref.focus()
      window.getSelection().selectAllChildren(this.ref)
      window.getSelection().collapseToEnd()
      $(this.div_id).val($(this.textarea_id).html())
    }
  }
  
  onInput(ev) {
    if(this.ev_type == "INCIDENT"){
      var note_id = this.textarea_id.replace("#", "")
    }else{
      var note_id = this.div_id.replace("#", "")
    }
    let positionIndex = getCaretCharacterOffsetWithin(document.getElementById(note_id))
    const textBeforeCaret = this.ref.innerText.slice(0, positionIndex)
    const tokens = textBeforeCaret.split(/\s/)
    const lastToken = tokens[tokens.length - 1]
    const triggerIdx = textBeforeCaret.endsWith(lastToken)
      ? textBeforeCaret.length - lastToken.length
      : -1
    const maybeTrigger = textBeforeCaret[triggerIdx]
    const keystrokeTriggered = maybeTrigger === '@'
    if (!keystrokeTriggered) {
      this.closeMenu()
      return
    }
    $(this.menu_id).show()
    const query = textBeforeCaret.slice(triggerIdx + 1)
    this.makeOptions(query)
    const coords = getCaretCoordinates(this.ref, positionIndex)
    const { top, left } = this.ref.getBoundingClientRect()
    var theString = this.ref.innerHTML;
    let div_space = (theString.split("<div><br></div>").length - 1) * 20
    setTimeout(() => {
      this.active = 0
      this.left = coords.left + this.ref.scrollLeft
      this.top = coords.top - this.ref.scrollTop + 20 + this.top_diff - div_space
      this.triggerIdx = triggerIdx
      this.renderMenu()
    }, 0)
  }
  
  onKeyDown(ev) {
    let keyCaught = false
    if (this.triggerIdx !== undefined) {
      switch (ev.key) {
        case 'ArrowDown':
          this.active = Math.min(this.active + 1, this.options.length - 1)
          this.renderMenu()
          keyCaught = true
          break
        case 'ArrowUp':
          this.active = Math.max(this.active - 1, 0)
          this.renderMenu()
          keyCaught = true
          break
        case 'Enter':
        case 'Tab':
          this.selectItem(this.active)()
          keyCaught = true
          break
      }
    }
    
    if (keyCaught) {
      ev.preventDefault()
    }
  }
  
  renderMenu() { 
    if (this.top === undefined) {
      this.menuRef.hidden = true
      return
    }
    this.menuRef.style.left = this.left + 'px'
    this.menuRef.style.top = this.top + 'px'
    this.menuRef.innerHTML = ''
    this.options.forEach((option, idx) => {
      this.menuRef.appendChild(this.menuItemFn(
        option,
        this.selectItem(idx),
        this.active === idx))
    })
    
    this.menuRef.hidden = false
    if (this.options.length == 0){
        $(this.menu_id).hide()
    }
  }
}

const users = [

]

const userData = {{users | safe}}
for (i=0; i<(userData.length); i++){
  users.push({username: userData[i].first_name + userData[i].last_name, user_id: userData[i].id})
}


const resolveFn = prefix => prefix === ''
  ? users
  : users.filter(user => (user.username).toLowerCase().startsWith(prefix.toLowerCase()))

const replaceFn = (user, trigger) => `${trigger}${user.username} `

const menuItemFn = (user, setItem, selected) => {
  const div = document.createElement('div')
  div.setAttribute('role', 'option')
  div.className = 'menu-area-item'
  div.setAttribute("user_id", user.user_id)
  if (selected) {
    div.classList.add('selected')
    div.setAttribute('aria-selected', '')
  }
  div.textContent = user.username
  div.onclick = setItem
  return div
}
</script>
</head>

<body>
  <div class="wrapper">

    {% include 'includes/sidebar.html' %}

    <div class="main-panel">

      {% block navigation %}
      {% include 'includes/navigation.html' %}
      {% endblock %}

      <div class="content">

        {% block breadcrumb %}{% endblock breadcrumb %}

        {% block content %}{% endblock content %}

      </div>

      {% include 'includes/footer.html' %}

    </div>
  </div>

  <!-- Specific Page JS goes HERE  -->
  {% block javascripts %}{% endblock javascripts %}

</body>

</html>
